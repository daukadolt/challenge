{
  "name": "Independent Code Review & Testing Policy Controls",
  "description": "Atomic rules extracted from the Independent Code Review and Testing Policy. Each rule is expressed as Context -> Requirement using robust matching operators and lists applicable exceptions from the policy.",
  "rules": [
    {
      "id": "CR-01",
      "type": "Blocking",
      "description": "Changes targeting main/release branches must have a code review completed before merge.",
      "logic": "PR.target_branch.matches('main','master','release') AND PR.merge_requested -> Review.exists AND Review.status == 'completed'",
      "exceptions": [
        "Documentation-Only Changes",
        "Build and Deployment Scripts",
        "Dependency Updates (version bumps)",
        "Proof of Concept / Experimental Features (explicitly temporary)"
      ]
    },
    {
      "id": "CR-02",
      "type": "Blocking",
      "description": "Code review approvals must be from an independent reviewer (four-eyes principle).",
      "logic": "PR.target_branch.matches('main','master','release') AND Review.exists -> Review.approvals.exists AND NOT Review.approvals.any(approver.matches(PR.author))",
      "exceptions": [
        "Documentation-Only Changes",
        "Build and Deployment Scripts",
        "Dependency Updates (version bumps)",
        "Proof of Concept / Experimental Features (explicitly temporary)"
      ]
    },
    {
      "id": "CR-03",
      "type": "Blocking",
      "description": "Code review approvals must be recorded in the system visible to the merge process.",
      "logic": "Review.exists AND PR.merge_requested -> PR.status_checks.contains('review') AND Review.record.exists",
      "exceptions": [
        "Documentation-Only Changes",
        "Build and Deployment Scripts",
        "Dependency Updates (version bumps)"
      ]
    },
    {
      "id": "TEST-01",
      "type": "Blocking",
      "description": "Unit test coverage for new code must meet minimum threshold.",
      "logic": "PR.changes.include_new_code -> Coverage.unit_percentage >= 80",
      "exceptions": [
        "Legacy Code Integration",
        "Third-Party Dependencies",
        "Proof of Concept / Experimental Features",
        "Documentation-Only Changes",
        "Build and Deployment Scripts",
        "Dependency Updates (version bumps)",
        "Refactoring with No Behavioral Changes"
      ]
    },
    {
      "id": "TEST-02",
      "type": "Blocking",
      "description": "Integration test coverage for critical integration points must meet minimum threshold.",
      "logic": "PR.changes.include_integration_points OR Files.path.contains('integration','api','service') -> Coverage.integration_percentage >= 60",
      "exceptions": [
        "Legacy Code Integration",
        "Third-Party Dependencies",
        "Proof of Concept / Experimental Features",
        "Documentation-Only Changes",
        "Build and Deployment Scripts",
        "Dependency Updates (version bumps)"
      ]
    },
    {
      "id": "TEST-03",
      "type": "Blocking",
      "description": "Critical security/payment/authentication paths must have 100% line coverage.",
      "logic": "Files.path.contains('security','payment','auth','authentication') OR PR.changes.include_critical_paths -> Coverage.line_percentage == 100",
      "exceptions": [
        "Legacy Code Integration",
        "Third-Party Dependencies",
        "Proof of Concept / Experimental Features",
        "Refactoring with No Behavioral Changes"
      ]
    },
    {
      "id": "TEST-04",
      "type": "Blocking",
      "description": "Coverage reports must be generated and attached to the code review.",
      "logic": "PR.merge_requested -> Artifacts.contains('coverage_report') AND PR.review.attachments.contains('coverage_report')",
      "exceptions": [
        "Documentation-Only Changes",
        "Build and Deployment Scripts",
        "Dependency Updates (version bumps)"
      ]
    },
    {
      "id": "TEST-05",
      "type": "Blocking",
      "description": "Branch coverage must meet minimum threshold across the change.",
      "logic": "PR.changes.include_code -> Coverage.branch_percentage >= 70",
      "exceptions": [
        "Legacy Code Integration",
        "Third-Party Dependencies",
        "Proof of Concept / Experimental Features",
        "Documentation-Only Changes",
        "Build and Deployment Scripts",
        "Dependency Updates (version bumps)"
      ]
    },
    {
      "id": "TEST-06",
      "type": "Blocking",
      "description": "Function coverage must meet minimum threshold across the change.",
      "logic": "PR.changes.include_code -> Coverage.function_percentage >= 80",
      "exceptions": [
        "Legacy Code Integration",
        "Third-Party Dependencies",
        "Proof of Concept / Experimental Features",
        "Documentation-Only Changes",
        "Build and Deployment Scripts",
        "Dependency Updates (version bumps)"
      ]
    },
    {
      "id": "TEST-07",
      "type": "Blocking",
      "description": "All unit tests must pass with zero failures before release/merge.",
      "logic": "PR.merge_requested OR PR.target_branch.matches('main','master','release') -> CI.status.unit_tests == 'passed' AND CI.tests.unit_failures == 0",
      "exceptions": [
        "Documentation-Only Changes",
        "Build and Deployment Scripts",
        "Dependency Updates (version bumps)"
      ]
    },
    {
      "id": "TEST-08",
      "type": "Blocking",
      "description": "All integration tests must pass before release/merge.",
      "logic": "PR.merge_requested AND PR.changes.include_integration_points -> CI.status.integration_tests == 'passed'",
      "exceptions": [
        "Third-Party Dependencies",
        "Proof of Concept / Experimental Features",
        "Documentation-Only Changes",
        "Build and Deployment Scripts"
      ]
    },
    {
      "id": "TEST-09",
      "type": "Blocking",
      "description": "Critical end-to-end user journeys must pass for changes affecting those journeys.",
      "logic": "PR.changes.affect_critical_user_journeys -> CI.status.e2e_critical == 'passed'",
      "exceptions": [
        "Proof of Concept / Experimental Features",
        "Documentation-Only Changes"
      ]
    },
    {
      "id": "TEST-10",
      "type": "Blocking",
      "description": "Performance tests must pass when a change impacts performance or performance tests are applicable.",
      "logic": "PR.changes.affects_performance == true OR Change.flagged.performance_applicable == true -> CI.status.performance_tests == 'passed'",
      "exceptions": [
        "Proof of Concept / Experimental Features",
        "Documentation-Only Changes",
        "Build and Deployment Scripts"
      ]
    },
    {
      "id": "TEST-11",
      "type": "Blocking",
      "description": "Security scans must be run, reviewed, and marked approved prior to release for code changes.",
      "logic": "PR.merge_requested AND PR.changes.include_code -> CI.status.security_scan == 'completed' AND CI.reviews.security_scan == 'approved'",
      "exceptions": [
        "Documentation-Only Changes",
        "Build and Deployment Scripts",
        "Dependency Updates (version bumps)"
      ]
    },
    {
      "id": "TEST-12",
      "type": "Blocking",
      "description": "All tests must run in CI/CD pipeline before merge and be executed in a clean environment (no cached dependencies).",
      "logic": "PR.merge_requested -> CI.pipeline.exists AND CI.pipeline.runs.tests == true AND CI.pipeline.env.clean == true",
      "exceptions": [
        "Documentation-Only Changes",
        "Build and Deployment Scripts",
        "Dependency Updates (version bumps)"
      ]
    },
    {
      "id": "TEST-13",
      "type": "Blocking",
      "description": "Test results must be visible as PR status checks.",
      "logic": "PR.merge_requested -> PR.status_checks.contains('unit') AND PR.status_checks.contains('integration') AND PR.status_checks.contains('security')",
      "exceptions": [
        "Documentation-Only Changes",
        "Refactoring with No Behavioral Changes",
        "Build and Deployment Scripts",
        "Dependency Updates (version bumps)"
      ]
    },
    {
      "id": "TEST-14",
      "type": "Blocking",
      "description": "Flaky tests must be fixed or removed before the code is released/merged.",
      "logic": "Test.flaky == true AND PR.target_branch.matches('main','master','release') -> (Test.fixed_within_days <= 2) OR Test.removed == true",
      "exceptions": [
        "Legacy Code Integration (where fixing is impractical)",
        "Proof of Concept / Experimental Features"
      ]
    },
    {
      "id": "TQ-01",
      "type": "Audit",
      "description": "Tests must be deterministic, repeatable, independent, and clean up after themselves.",
      "logic": "Test.exists -> Test.deterministic == true AND Test.repeatable == true AND Test.independent == true AND Test.cleans_up == true",
      "exceptions": [
        "Legacy Code Integration",
        "Third-Party Dependencies",
        "Proof of Concept / Experimental Features"
      ]
    },
    {
      "id": "TQ-02",
      "type": "Audit",
      "description": "Test names must clearly describe purpose and include positive and negative cases.",
      "logic": "Test.exists -> Test.name.matches('descriptive') AND Test.cases.includes('positive') AND Test.cases.includes('negative')",
      "exceptions": [
        "Proof of Concept / Experimental Features",
        "Documentation-Only Changes"
      ]
    },
    {
      "id": "TM-01",
      "type": "Audit",
      "description": "Flaky tests must be tracked and fixed within 2 business days or removed; this is measured over time.",
      "logic": "Test.flaky == true -> Tracking.ticket.exists AND Ticket.slack_timeline <= 2_business_days OR Test.removed == true",
      "exceptions": [
        "Legacy Code Integration",
        "Proof of Concept / Experimental Features"
      ]
    },
    {
      "id": "POLICY-01",
      "type": "Audit",
      "description": "Policy reviewed and updated quarterly.",
      "logic": "Date.now -> Policy.last_review_date <= Date.now.minus(90_days)",
      "exceptions": []
    }
  ]
}